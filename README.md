# BugChat — Telegram-бот на Google Sheets

Бот на **Go** с библиотеками **gopkg.in/telebot.v3** и **google.golang.org/api/sheets/v4**: интерфейсный текст, категории, документы, пожелания и заявки IMO хранятся в Google Таблице.

---

## 1. BotFather

1. Открой [@BotFather](https://t.me/BotFather) в Telegram.
2. `/newbot` → введи имя и username бота.
3. Сохрани **токен** (например, `123456789:AAH...`).

---

## 2. Google Cloud

### 2.1. Проект и API

1. [Google Cloud Console](https://console.cloud.google.com/) → **Создать проект** (или выбери существующий).
2. **API и сервисы** → **Включить API и сервисы** → найди **Google Sheets API** → **Включить**.

### 2.2. Service Account

1. **API и сервисы** → **Учётные данные** → **Создать учётные данные** → **Сервисный аккаунт**.
2. Имя (например, `bugchat-bot`) → **Создать и продолжить** → (роль не обязательна) → **Готово**.
3. В списке сервисных аккаунтов открой созданный → вкладка **Ключи** → **Добавить ключ** → **Создать новый ключ** → **JSON** → скачай файл.
4. Переименуй файл в **`credentials.json`** и положи в корень проекта (или укажи путь в `CREDENTIALS_PATH`).

### 2.3. Доступ к таблице

1. Создай Google Таблицу или открой существующую.
2. Из `credentials.json` скопируй `client_email` (например, `bugchat-bot@project.iam.gserviceaccount.com`).
3. В таблице: **Поделиться** → вставь этот email → роль **Редактор** → **Отправить**.

ID таблицы возьми из URL:
`https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`  
→ `SPREADSHEET_ID` — это нужное значение.

---

## 3. Переменные окружения

Скопируй `env.example` в `.env` и заполни:

```env
BOT_TOKEN=123456789:AAH...
SPREADSHEET_ID=твой_spreadsheet_id
CREDENTIALS_PATH=credentials.json
CACHE_TTL_MIN=5
YANDEX_MAX_MB=50
```

Либо экспортируй переменные в системе. Поддерживается и ручной разбор `.env` (без `godotenv`): `KEY=value`, пустые и `#` строки игнорируются.

---

## 4. Запуск

```bash
go mod tidy   # при необходимости
go run .
```

При первом запуске бот сам создаст листы, если их нет.

**Заполнить «Настройки_Текста» из примера:**

```bash
go run . -fill-settings
```

Записывает данные из `settings_text.example.csv` в лист «Настройки_Текста». Нужны `SPREADSHEET_ID` и `CREDENTIALS_PATH` в `.env` (BOT_TOKEN не обязателен).

**Заполнить тестовыми данными (категории, документы, админы):**

```bash
go run . -fill-test-data
```

Пишет в «Категории» (2), «Документы» (4), добавляет в «Админы» строку `ЗАМЕНИТЕ_НА_СВОЙ_ЮЗЕРНЕЙМ` — замените на свой @username или допишите себя вручную.

---

## 5. Первичная настройка таблицы

### 5.1. Лист «Настройки_Текста»

Колонки: **Ключ** | **Текст**.

Пример строк — в файле **[`settings_text.example.csv`](settings_text.example.csv)**. Импорт вручную (Файл → Импорт) или `go run . -fill-settings`.

| Ключ                     | Назначение                                                                     |
|--------------------------|-------------------------------------------------------------------------------|
| Приветствие              | Сообщение по `/start`                                                         |
| Описание_Документы       | Текст перед списком категорий                                                 |
| Описание_Пожелания       | Подсказка перед вводом пожелания                                              |
| Описание_IMO             | Подсказка перед вводом заявки (4 строки: ФИО, Телефон, Должность, Источник)   |
| Текст_Ошибки_Анкеты      | Сообщение, если в заявке IMO меньше 4 строк                                   |

### 5.2. Лист «Админы»

Колонки: **Юзернейм** | **ID_Чата**.

- В первую колонку впиши свой `@username` (например, `ivan`).
- **ID_Чата** оставь пустым: он подставится после того, как ты напишешь боту `/start`.

---

## 6. Проверка

1. Напиши боту `/start`.
2. Бот подхватит твой `ID_Чата` в «Админы» и покажет в меню (кнопка Menu) команды `/send` и `/reload`.
3. Заполни «Настройки_Текста» и при необходимости «Категории», «Документы» и т.д.

### Полная проверка (чека-лист)

После `-fill-settings` и `-fill-test-data`:

| Действие | Ожидание |
|----------|----------|
| `/start` | Приветствие и 3 кнопки: «Список документов», «Пожелания», «Запросить доступ в IMO» |
| «Список документов» | Inline-кнопки: «Внутренние документы», «Полезные ссылки» |
| Выбор категории | Список документов (название, описание), кнопки «Скачать» и «« Назад» |
| «Скачать» (example.com) | Сообщение со ссылкой |
| «Скачать» (disk.yandex.ru) | Попытка отправить файл; при ошибке — ссылка |
| « Назад | Возврат к списку категорий |
| «Пожелания» | Подсказка, затем ввод текста → запись в «Пожелания» |
| «Запросить доступ в IMO» | Подсказка; &lt;4 строк — ошибка; 4+ строк — запись в «Заявки_IMO» |
| Кнопка главного меню во время ввода пожелания/IMO | Сброс FSM, переход в выбранный раздел |
| Админ: `/send Текст` | Рассылка всем из «Пользователи» |
| Админ: `/reload` | «Кэш сброшен» |
| В «Админы» свой @username, затем `/start` | В Menu появятся `/send`, `/reload` |

---

## Структура проекта

| Файл                 | Назначение                                                                 |
|----------------------|----------------------------------------------------------------------------|
| `main.go`            | Точка входа, кэш (тексты, категории, админы), FSM, загрузка `.env`, `EnsureSheets` при старте |
| `handlers.go`        | Обработчики команд, кнопок, FSM (пожелания, IMO), `SetMyCommands` по scope, middleware для админов |
| `sheets_api.go`      | Работа с Google Sheets: листы, заголовки, чтение/запись, генерация UUID для пустого ID в «Категории» |
| `yandex_downloader.go` | Ссылки `disk.yandex.ru` → прямая загрузка; при ошибке или >50 MB — отдача ссылки текстом |
| `config.go`          | `BOT_TOKEN`, `SPREADSHEET_ID`, `CREDENTIALS_PATH`, `CACHE_TTL_MIN`, `YANDEX_MAX_MB` из окружения |
| `env.example`        | Пример переменных для `.env`                                               |
| `settings_text.example.csv` | Пример пар «Ключ» / «Текст» для листа «Настройки_Текста»          |

---

## Листы и колонки (создаются автоматически при отсутствии)

| Лист             | Колонки                                                                 |
|------------------|-------------------------------------------------------------------------|
| Настройки_Текста | Ключ, Текст                                                             |
| Категории        | Название, ID (если ID пуст — пишется UUID)                              |
| Документы        | ID_Категории, Название, Описание, Ссылка                                |
| Пожелания        | Дата, Юзернейм, ID_Юзера, Текст                                         |
| Заявки_IMO       | Дата, Юзернейм, ID_Юзера, ФИО, Телефон, Должность, Источник             |
| Пользователи     | ID_Пользователя, Юзернейм, Дата_Регистрации                             |
| Админы           | Юзернейм, ID_Чата                                                       |
| Логи_Ошибок      | Дата, Ошибка, Контекст                                                  |

---

## Команды и логика

- **/start** — приветствие из «Настройки_Текста», кнопки: «Список документов», «Пожелания», «Запросить доступ в IMO». Регистрация в «Пользователи», проставление `ID_Чата` в «Админы», `SetMyCommands` по `CommandScopeChat` (админам — `/start`, `/send`, `/reload`; остальным — `/start`).
- **Список документов** — inline-кнопки категорий → список документов (HTML: название, описание), кнопки «Скачать» и «« Назад».
- **Яндекс.Диск** — при ссылке на `disk.yandex.ru` — попытка скачать и отправить файлом; при ошибке или размере >50 MB — ссылка текстом.
- **Пожелания** — FSM: ввод текста; при нажатии кнопок главного меню или `/start` состояние сбрасывается.
- **Заявки IMO** — FSM: ввод минимум 4 строк (ФИО, Телефон, Должность, Источник); при ошибке — «Текст_Ошибки_Анкеты».
- **/send [текст]** — рассылка всем из «Пользователи» (доступно только админам).
- **/reload** — сброс кэша (доступно только админам).

Критические ошибки API пишутся в «Логи_Ошибок» без остановки бота. Кэш: 5 минут (настраивается через `CACHE_TTL_MIN`).

---

## Зависимости

- `gopkg.in/telebot.v3` (tucnak/telebot v3)
- `google.golang.org/api` (sheets v4, option WithCredentialsFile)
- `github.com/google/uuid`

```bash
go get gopkg.in/telebot.v3 google.golang.org/api github.com/google/uuid
go mod tidy
```
