# BuhChat — Telegram-бот на Google Sheets

Telegram-бот на **Go** для выдачи документов по категориям, приёма пожеланий и заявок на доступ в IMO. Тексты, категории, документы, пользователи и админы хранятся в **Google Таблице**. Файлы с **Яндекс.Диска** отдаются через бота в виде ZIP (прокси-архивация) без передачи прямой ссылки пользователю.

---

## Возможности

| Функция | Описание |
|--------|----------|
| **Документы по категориям** | Категории → список документов (название, описание). Под каждым документом со ссылкой — кнопка «Скачать файл» (callback); внизу [Скачать все] и [« Назад]. Гиперссылки в тексте не используются. |
| **Прокси-архивация** | По нажатию «Скачать»: при наличии сохранённого `File_ID` — мгновенная отправка; иначе — скачивание с Яндекса, упаковка в ZIP, отправка и сохранение `File_ID` в таблицу. Прямые ссылки на Яндекс.Диск пользователю не показываются. |
| **Пожелания** | Пользователь вводит текст → запись в лист «Пожелания» + уведомление всем админам с заполненным `ID_Чата`. |
| **Заявки IMO** | Анкета из 4 полей (ФИО, Телефон, Должность, Источник) → лист «Заявки_IMO» + уведомление админам. |
| **Админы** | Лист «Админы»: юзернейм и `ID_Чата` (подставляется при первом `/start`). Админам: `/send <текст>` — рассылка по «Пользователи»; `/reload` — сброс кэша. |
| **Схема и миграции** | При старте `EnsureSchema`: создаёт отсутствующие листы и дописывает в конец первой строки недостающие колонки (например, `File_ID` в «Документы»). |

---

## Стек и зависимости

- **Go 1.20+**
- **gopkg.in/telebot.v3** — Telegram Bot API
- **google.golang.org/api/sheets/v4** — Google Sheets API
- **github.com/google/uuid** — UUID для категорий и документов

```bash
go get gopkg.in/telebot.v3 google.golang.org/api github.com/google/uuid
go mod tidy
```

---

## Настройка

### 1. BotFather

1. [@BotFather](https://t.me/BotFather) → `/newbot` → имя и username.
2. Сохрани **токен** и **username** (без `@`).

### 2. Google Cloud

1. [Google Cloud Console](https://console.cloud.google.com/) → проект → **API и сервисы** → включить **Google Sheets API**.
2. **Учётные данные** → **Сервисный аккаунт** → создать → **Ключи** → JSON. Переименуй в `credentials.json` в корень проекта (или укажи путь в `CREDENTIALS_PATH`).
3. В Google Таблице: **Поделиться** → `client_email` из `credentials.json` → роль **Редактор**.

ID таблицы: из URL `https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/edit`.

### 3. Переменные окружения

Скопируй `env.example` в `.env` и заполни:

| Переменная | Описание |
|------------|----------|
| `BOT_TOKEN` | Токен от BotFather |
| `BOT_USERNAME` | Юзернейм бота без `@` (опционально; в сообщениях ссылки t.me не выводятся) |
| `SPREADSHEET_ID` | ID Google Таблицы |
| `CREDENTIALS_PATH` | Путь к JSON ключу (по умолчанию `credentials.json`) |
| `CACHE_TTL_MIN` | TTL кэша в минутах (по умолчанию 5) |
| `YANDEX_MAX_MB` | Макс. размер файла с Яндекса в МБ для скачивания (по умолчанию 50) |

Бот загружает `.env` при старте (строки `KEY=value`, пустые и `#` игнорируются).

---

## Запуск

```bash
# Обычный запуск (long polling)
go run .
# или
./bugchat
```

Перед первым запуском: `BOT_TOKEN`, `SPREADSHEET_ID`, `CREDENTIALS_PATH`. `EnsureSchema` создаст недостающие листы и колонки.

**Заполнить «Настройки_Текста» из CSV:**

```bash
go run . -fill-settings
```

Берёт пары «Ключ» / «Текст» из `settings_text.example.csv` (или своего CSV по тому же формату).

**Тестовые данные (категории, документы, админы):**

```bash
go run . -fill-test-data
```

Добавляет 2 категории, 4 документа и строку в «Админы» `ЗАМЕНИТЕ_НА_СВОЙ_ЮЗЕРНЕЙМ` — замени на свой @username.

---

## Листы Google Таблицы

Создаются при первом запуске; при `EnsureSchema` недостающие колонки дописываются в первую строку.

| Лист | Колонки | Назначение |
|------|---------|------------|
| **Настройки_Текста** | Ключ, Текст | Приветствие, подсказки для документов/пожеланий/IMO, текст ошибки анкеты. |
| **Категории** | Название, ID | ID — UUID; если пуст, генерируется при чтении. |
| **Документы** | ID_Категории, Название, Описание, Ссылка, **File_ID** | **File_ID** — Telegram `file_id` архива (ZIP); заполняется после первой успешной прокси-отправки. |
| **Пожелания** | Дата, Юзернейм, ID_Юзера, Текст | |
| **Заявки_IMO** | Дата, Юзернейм, ID_Юзера, ФИО, Телефон, Должность, Источник | |
| **Пользователи** | ID_Пользователя, Юзернейм, Дата_Регистрации | Для `/send` и учёта. |
| **Админы** | Юзернейм, **ID_Чата** | **ID_Чата** заполняется при первом `/start` админа. Нужен для уведомлений и проверки прав. |
| **Логи_Ошибок** | Дата, Ошибка, Контекст | Критические ошибки API, `notifyAdmins`, `SetAdminChatID` и т.п. |

---

## Логика документов и скачивания

1. **Список документов** — inline-кнопки категорий → по выбору категории: один блок на документ (название, описание), под каждым документом со ссылкой — кнопка «Скачать файл» (callback `doc|categoryID|idx`); внизу один ряд [Скачать все] и [« Назад]. `DisableWebPagePreview`. Гиперссылки в тексте не используются. Нажатие любой inline-кнопки (категория, «Скачать файл», «Скачать все», « Назад) сбрасывает FSM.
2. **По нажатию «Скачать файл» или по старым deep-link `/start dl_XXX`:**
   - Сообщение «⏳ Подготавливаю файл...» → удаляется после отправки.
   - Если в «Документы» есть **File_ID** — сразу отправка документа по `file_id`.
   - Иначе:
     - Проверка свободного места в `os.TempDir()`: если &lt; 100 МБ — «Место на сервере ограничено, скачайте по ссылке: [URL]».
     - Размер &gt; 50 МБ (лимит Telegram) или не Яндекс.Диск — отдача ссылки текстом.
     - Скачивание с Яндекса (HTML + при необходимости Cloud API) → временный файл → ZIP (`archive/zip`) → отправка → сохранение `File_ID` в колонку E; удаление временных файлов (`defer`).
3. **Фоновая очистка:** раз в час в `os.TempDir()` удаляются файлы с префиксом `bugchat-` старше 30 минут.

---

## Яндекс.Диск

- Поддерживаются `disk.yandex.ru` и `disk.yandex.com`.
- Прямая ссылка: редирект `Location`, поиск `downloader.disk.yandex` в HTML, при неудаче — **Cloud API** `public_key` (без OAuth).
- Лимит размера — `YANDEX_MAX_MB` (проверка по `Content-Length` / при скачивании). При превышении или не-Яндекс URL пользователь получает текст со ссылкой.

---

## Админы и уведомления

- **Права:** лист «Админы», колонка A — юзернейм (сравнение без учёта регистра). `ID_Чата` в B заполняется при первом `/start`; если пуст — уведомления этому админу не уходят.
- **Уведомления:** при новой записи в «Пожелания» или «Заявки_IMO» в фоне вызывается `notifyAdmins`; рассылка всем, у кого в «Админы» заполнен `ID_Чата`.
- **Команды:** `/send <текст>` — рассылка по «Пользователи»; `/reload` — сброс кэша (тексты, категории, админы).

---

## Структура проекта

| Файл | Назначение |
|------|------------|
| `main.go` | Точка входа, загрузка `.env`, `EnsureSchema`, кэш (тексты, категории, админы), FSM, `getFreeSpaceBytes`, `StartCleanupWorker`, `-fill-settings` / `-fill-test-data`. |
| `handlers.go` | `/start` (в т.ч. deep-link `dl_`), главное меню, категории и документы, `runProxyArchive`, `handleDeepLink`, `notifyAdmins`, FSM пожелания/IMO, `onSend`, `onReload`, `SetMyCommands` по `CommandScopeChat`. |
| `sheets_api.go` | Sheets API: `EnsureSheets`, `EnsureSchema`, `ensureSheetColumns`, чтение/запись листов, `GetCategories` (с автоподстановкой UUID), `GetDocumentsByCategory` (A–E, `File_ID`, `SheetRow`), `UpdateDocumentFileID`, `GetAdmins` / `GetAdminChatIDs`, `SetAdminChatID`, `GetAllUserChatIDs`, `AppendWish` / `AppendIMO`, `EnsureUser`, `LogError`. |
| `yandex_downloader.go` | `GetDirectURL` (HTML + Cloud API), `GetFile`, `GetFileSize`, `DownloadToFile`; лимит `maxSize`, `ErrNotYandexDisk`, `ErrFileTooLarge`. |
| `downloader.go` | `ZipBytesToTemp`, `BulkDownloadAndZip`, `ErrArchiveTooLarge`; сборка ZIP, проверка места, лимит 50 МБ. |
| `config.go` | `LoadConfig`: `BOT_TOKEN`, `BOT_USERNAME`, `SPREADSHEET_ID`, `CREDENTIALS_PATH`, `CACHE_TTL_MIN`, `YANDEX_MAX_MB`. |
| `env.example` | Пример переменных для `.env`. |
| `settings_text.example.csv` | Пример пар «Ключ» / «Текст» для «Настройки_Текста». |
| `create_github_repo.go` | Утилита (go:build ignore) для создания репозитория Buh_Chat_bot через GitHub API. |
| `create_github_repo.sh` | Скрипт создания репозитория (нужен `GITHUB_TOKEN`). |

---

## Чек-лист проверки

| Действие | Ожидание |
|----------|----------|
| `/start` | Приветствие, кнопки: «Список документов», «Пожелания», «Запросить доступ в IMO». |
| «Список документов» | Inline-кнопки категорий. |
| Выбор категории | Документы (название, описание), под каждым — «Скачать файл»; внизу [Скачать все] и [« Назад]. |
| «Скачать» (Яндекс) | «⏳ Подготавливаю...» → ZIP или, при ошибке/лимите, ссылка. Повторное нажатие — по `File_ID` без повторной загрузки. |
| «Скачать» (не Яндекс) | Ссылка текстом. |
| «Пожелания» | Ввод текста → «Спасибо!»; запись в «Пожелания»; уведомление админам. |
| «Запросить доступ в IMO» | 4+ строк (ФИО, Телефон, Должность, Источник) → «Заявка принята»; запись в «Заявки_IMO»; уведомление админам. |
| Админ: `/send Текст` | Рассылка по «Пользователи». |
| Админ: `/reload` | «Кэш сброшен». |
| Админ в «Админы», первый `/start` | В меню — `/send`, `/reload`; в «Админы» в B записан `ID_Чата`. |

---

## Лицензия

Проект в репозитории [SultanowMarat/BuhChat](https://github.com/SultanowMarat/BuhChat).
